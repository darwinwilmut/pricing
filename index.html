<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Freelance Timer Pro</title>
    <style>
        :root {
            --bg-color: #f5f5f5;
            --container-bg: #ffffff;
            --text-color: #333333;
            --text-secondary: #6b7280;
            --timer-bg: #3b82f6;
            --timer-text: #ffffff;
            --accent-color: #3b82f6;
            --result-bg: #f3f4f6;
            --border-color: #d1d5db;
            --shadow: rgba(0, 0, 0, 0.1);
            --break-color: #f59e0b;
            --work-color: #10b981;
        }

        body.dark-mode {
            --bg-color: #1a1a1a;
            --container-bg: #2d2d2d;
            --text-color: #e5e5e5;
            --text-secondary: #9ca3af;
            --timer-bg: #1e40af;
            --timer-text: #ffffff;
            --accent-color: #60a5fa;
            --result-bg: #3a3a3a;
            --border-color: #4a4a4a;
            --shadow: rgba(0, 0, 0, 0.5);
            --break-color: #f59e0b;
            --work-color: #10b981;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-color);
            min-height: 100vh;
            padding: 30px 20px 20px 20px; /* just enough for fixed controls */
            transition: background 0.3s ease;
        }

        .main-container {
            max-width: 900px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .container {
            background: var(--container-bg);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 4px 15px var(--shadow);
            position: relative;
            transition: background 0.3s ease, box-shadow 0.3s ease;
        }

        .theme-toggle {
            position: fixed;
            top: 10px;
            right: 10px;
            background: var(--accent-color);
            border: none;
            padding: 8px 12px;
            border-radius: 50px;
            cursor: pointer;
            font-size: 16px;
            transition: transform 0.3s ease, background 0.3s ease;
            z-index: 1001;
            box-shadow: 0 2px 10px var(--shadow);
        }

        .theme-toggle:hover {
            transform: scale(1.1);
        }

        .sound-toggle {
            position: fixed;
            top: 10px;
            right: 65px;
            background: var(--accent-color);
            border: none;
            padding: 8px 12px;
            border-radius: 50px;
            cursor: pointer;
            font-size: 16px;
            transition: transform 0.3s ease, background 0.3s ease;
            z-index: 1001;
            box-shadow: 0 2px 10px var(--shadow);
        }

        .sound-toggle:hover {
            transform: scale(1.1);
        }

        .sound-toggle.muted {
            opacity: 0.5;
        }

        .sync-indicator {
            position: fixed;
            top: 10px;
            right: 120px;
            background: var(--accent-color);
            border: none;
            padding: 8px 12px;
            border-radius: 50px;
            font-size: 14px;
            z-index: 1001;
            box-shadow: 0 2px 10px var(--shadow);
            color: white;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .sync-indicator.syncing {
            background: #f59e0b;
            animation: pulse 1.5s infinite;
        }

        .sync-indicator.synced {
            background: #10b981;
        }

        .sync-indicator.offline {
            background: #ef4444;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        h1 {
            text-align: center;
            color: var(--text-color);
            margin-bottom: 10px;
            font-size: 24px;
            font-weight: 600;
            transition: color 0.3s ease;
        }

        h2 {
            color: var(--text-color);
            margin-bottom: 18px;
            font-size: 20px;
            font-weight: 600;
            transition: color 0.3s ease;
        }

        .rate-info {
            text-align: center;
            color: var(--accent-color);
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 20px;
            transition: all 0.3s ease;
            cursor: pointer;
            padding: 8px 16px;
            border-radius: 20px;
            background: var(--result-bg);
            display: inline-block;
            width: auto;
            margin-left: auto;
            margin-right: auto;
        }

        .rate-info:hover {
            background: var(--accent-color);
            color: white;
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
        }

        .rate-info::before {
            content: '‚öôÔ∏è ';
            font-size: 12px;
        }

        .last-earned {
            text-align: center;
            color: #10b981;
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 20px;
            transition: all 0.3s ease;
            cursor: default;
            padding: 10px 20px;
            border-radius: 25px;
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(16, 185, 129, 0.05));
            border: 2px solid rgba(16, 185, 129, 0.3);
            display: inline-block;
            width: auto;
            margin-left: auto;
            margin-right: auto;
            box-shadow: 0 2px 10px rgba(16, 185, 129, 0.2);
        }

        .last-earned::before {
            content: 'üí∞ ';
            font-size: 14px;
        }

        .last-earned:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }

        .timer-display {
            background: var(--timer-bg);
            color: var(--timer-text);
            font-size: 48px;
            font-weight: bold;
            text-align: center;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 20px;
            font-family: 'Courier New', monospace;
            letter-spacing: 2px;
            transition: background 0.3s ease;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .time-breakdown {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .time-stat {
            background: var(--result-bg);
            padding: 15px 12px;
            border-radius: 10px;
            text-align: center;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .time-stat:hover {
            border-color: var(--accent-color);
            transform: translateY(-2px);
        }

        .time-stat-label {
            font-size: 11px;
            color: var(--text-secondary);
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        .time-stat-value {
            font-size: 18px;
            font-weight: bold;
            color: var(--text-color);
            font-family: 'Courier New', monospace;
        }

        .time-stat.work .time-stat-value {
            color: var(--work-color);
        }

        .time-stat.break .time-stat-value {
            color: var(--break-color);
        }

        .time-stat.billable .time-stat-value {
            color: var(--accent-color);
        }

        .status-indicator {
            text-align: center;
            padding: 10px 18px;
            border-radius: 10px;
            margin-bottom: 18px;
            font-weight: 600;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.3s ease;
        }

        .status-indicator.working {
            background: rgba(16, 185, 129, 0.2);
            color: var(--work-color);
            border: 2px solid var(--work-color);
        }

        .status-indicator.on-break {
            background: rgba(245, 158, 11, 0.2);
            color: var(--break-color);
            border: 2px solid var(--break-color);
        }

        .status-indicator.idle {
            background: var(--result-bg);
            color: var(--text-secondary);
            border: 2px solid var(--border-color);
        }

        .notes-area, .search-box {
            width: 100%;
            padding: 12px 15px;
            border-radius: 10px;
            border: 2px solid var(--border-color);
            background: var(--result-bg);
            color: var(--text-color);
            font-family: inherit;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .notes-area {
            margin-bottom: 18px;
            resize: vertical;
            min-height: 80px;
        }

        .search-box {
            margin-bottom: 15px;
        }

        .notes-area:focus, .search-box:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        .main-controls {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .action-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 18px;
        }

        button {
            padding: 12px 24px;
            font-size: 14px;
            font-weight: 600;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        button:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
        }

        button:active {
            transform: translateY(0);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .start-btn {
            background: linear-gradient(135deg, #10f544, #00d418);
            color: white;
            box-shadow: 0 3px 12px rgba(16, 245, 68, 0.6);
        }

        .start-btn:hover {
            box-shadow: 0 6px 20px rgba(16, 245, 68, 0.8);
        }

        .start-btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .stop-btn {
            background: linear-gradient(135deg, #ff4757, #ff3742);
            color: white;
            box-shadow: 0 3px 12px rgba(255, 71, 87, 0.6);
        }

        .stop-btn:hover {
            box-shadow: 0 6px 20px rgba(255, 71, 87, 0.8);
        }

        .stop-btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .reset-btn {
            background: linear-gradient(135deg, #c44569, #f8b500);
            color: white;
            box-shadow: 0 3px 12px rgba(196, 69, 105, 0.6);
        }

        .reset-btn:hover {
            box-shadow: 0 6px 20px rgba(196, 69, 105, 0.8);
        }

        .calculate-btn {
            background: linear-gradient(135deg, #00d2ff, #3a7bd5);
            color: white;
            grid-column: 1 / -1;
            padding: 16px;
            font-size: 15px;
            font-weight: 700;
            box-shadow: 0 4px 15px rgba(0, 210, 255, 0.6);
            margin-top: 5px;
        }

        .calculate-btn:hover {
            box-shadow: 0 6px 25px rgba(0, 210, 255, 0.8);
        }

        .break-btn {
            background: linear-gradient(135deg, #ff9ff3, #f368e0);
            color: white;
            box-shadow: 0 3px 12px rgba(255, 159, 243, 0.6);
        }

        .break-btn:hover {
            box-shadow: 0 6px 20px rgba(255, 159, 243, 0.8);
        }

        .break-btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .work-btn {
            background: linear-gradient(135deg, #00cec9, #55a3ff);
            color: white;
            box-shadow: 0 3px 12px rgba(0, 206, 201, 0.6);
        }

        .work-btn:hover {
            box-shadow: 0 6px 20px rgba(0, 206, 201, 0.8);
        }

        .work-btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .result {
            background: var(--container-bg);
            padding: 0;
            border-radius: 16px;
            margin-top: 15px;
            display: none;
            transition: all 0.3s ease;
            border: 2px solid var(--border-color);
            position: relative;
            overflow: hidden;
            box-shadow: 0 8px 24px var(--shadow);
        }

        .result.show {
            display: block;
            animation: slideInScale 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        @keyframes slideInScale {
            0% {
                opacity: 0;
                transform: translateY(-20px) scale(0.95);
            }
            100% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .result-success-banner {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            padding: 12px;
            text-align: center;
            color: white;
            font-weight: 700;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .result-success-banner::before {
            content: '‚úì';
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 20px;
            height: 20px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            font-size: 12px;
        }

        .result-content {
            padding: 20px;
        }

        .result h3 {
            display: none;
        }

        .total-amount {
            margin-bottom: 16px;
            padding: 20px;
            background: linear-gradient(135deg, #fbbf24, #f59e0b, #d97706);
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 20px rgba(251, 191, 36, 0.5);
            position: relative;
            overflow: hidden;
        }

        .total-amount::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(
                45deg,
                transparent,
                rgba(255, 255, 255, 0.1),
                transparent
            );
            transform: rotate(45deg);
            animation: shine 3s infinite;
        }

        @keyframes shine {
            0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
            100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
        }

        .total-amount .result-label {
            color: rgba(255, 255, 255, 0.95);
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
            font-weight: 600;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .total-amount .result-label::before {
            display: none;
        }

        .total-amount .result-value {
            color: white;
            font-size: 32px;
            font-weight: 800;
            font-family: 'Courier New', monospace;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            position: relative;
            z-index: 1;
        }

        .result-stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }

        .result-item {
            background: var(--result-bg);
            padding: 12px;
            border-radius: 10px;
            text-align: center;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .result-item:hover {
            border-color: var(--accent-color);
            transform: translateY(-2px);
        }

        .result-label {
            color: var(--text-secondary);
            font-weight: 600;
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
        }

        .result-label::before {
            display: none;
        }

        .result-value {
            color: var(--text-color);
            font-weight: 700;
            font-size: 13px;
            font-family: 'Courier New', monospace;
        }

        .session-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-height: 400px;
            overflow-y: auto;
            padding-right: 5px;
        }

        .session-list::-webkit-scrollbar {
            width: 6px;
        }

        .session-list::-webkit-scrollbar-track {
            background: var(--result-bg);
            border-radius: 3px;
        }

        .session-list::-webkit-scrollbar-thumb {
            background: var(--accent-color);
            border-radius: 3px;
            opacity: 0.7;
        }

        .session-list::-webkit-scrollbar-thumb:hover {
            opacity: 1;
        }

        .session-item {
            background: var(--result-bg);
            padding: 15px;
            border-radius: 12px;
            border-left: 4px solid var(--accent-color);
            transition: all 0.3s ease;
            box-shadow: 0 1px 5px rgba(0, 0, 0, 0.05);
        }

        .session-item:hover {
            transform: translateX(3px);
            box-shadow: 0 3px 12px var(--shadow);
        }

        .session-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            align-items: center;
        }

        .session-date {
            color: var(--text-color);
            font-weight: 600;
            font-size: 12px;
        }

        .session-time {
            color: var(--accent-color);
            font-weight: 700;
            font-size: 12px;
        }

        .session-notes {
            color: var(--text-secondary);
            font-size: 12px;
            margin-bottom: 8px;
            line-height: 1.4;
        }

        .session-earnings {
            color: var(--text-color);
            font-weight: 600;
            font-size: 13px;
            margin-bottom: 10px;
        }

        .session-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 10px;
        }

        .session-actions button {
            padding: 8px 16px;
            font-size: 12px;
            border-radius: 20px;
        }

        .edit-session-btn {
            background: linear-gradient(135deg, #00d2ff, #928dab);
            color: white;
            box-shadow: 0 2px 8px rgba(0, 210, 255, 0.6);
        }

        .edit-session-btn:hover {
            box-shadow: 0 4px 12px rgba(0, 210, 255, 0.8);
        }

        .delete-session-btn {
            background: linear-gradient(135deg, #ff6348, #ff4757);
            color: white;
            box-shadow: 0 2px 8px rgba(255, 99, 72, 0.6);
        }

        .delete-session-btn:hover {
            box-shadow: 0 4px 12px rgba(255, 99, 72, 0.8);
        }


        .summary-tabs {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .tab-btn {
            padding: 10px 15px;
            background: var(--result-bg);
            color: var(--text-color);
            border: 2px solid var(--border-color);
            transition: all 0.3s ease;
            font-size: 13px;
            font-weight: 600;
            border-radius: 10px;
        }

        .tab-btn:hover {
            border-color: var(--accent-color);
            transform: translateY(-2px);
        }

        .tab-btn.active {
            background: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
        }

        .summary-content {
            display: none;
        }

        .summary-content.active {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .summary-stat {
            background: var(--result-bg);
            padding: 20px 18px;
            border-radius: 12px;
            text-align: center;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .summary-stat:hover {
            border-color: var(--accent-color);
            transform: translateY(-2px);
            box-shadow: 0 3px 12px var(--shadow);
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 11px;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        .stat-value {
            color: var(--accent-color);
            font-size: 24px;
            font-weight: bold;
        }

        .clear-btn {
            background: linear-gradient(135deg, #ff6b6b, #ee5a52);
            color: white;
            width: 100%;
            margin-top: 18px;
            padding: 12px;
            font-size: 14px;
            box-shadow: 0 3px 12px rgba(255, 107, 107, 0.6);
        }

        .clear-btn:hover {
            box-shadow: 0 6px 20px rgba(255, 107, 107, 0.8);
            background: linear-gradient(135deg, #ee5a52, #ff6b6b);
        }

        .empty-state {
            text-align: center;
            color: var(--text-secondary);
            padding: 40px 20px;
            font-size: 14px;
            font-style: italic;
        }

        /* PIN Modal Styles */
        .pin-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .pin-modal-content {
            background: var(--container-bg);
            padding: 40px 35px;
            border-radius: 20px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .pin-input {
            width: 100%;
            padding: 18px 20px;
            font-size: 24px;
            text-align: center;
            border: 3px solid var(--border-color);
            border-radius: 15px;
            background: var(--result-bg);
            color: var(--text-color);
            font-weight: bold;
            letter-spacing: 8px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
            font-family: 'Courier New', monospace;
        }

        .pin-input:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
            transform: scale(1.02);
        }

        .pin-submit-btn {
            width: 100%;
            padding: 18px;
            font-size: 16px;
            font-weight: 700;
            background: linear-gradient(135deg, #10f544, #00d418);
            color: white;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 4px 15px rgba(16, 245, 68, 0.4);
        }

        .pin-submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(16, 245, 68, 0.6);
        }

        .pin-submit-btn:active {
            transform: translateY(0);
        }

        .pin-secondary-btn {
            width: 100%;
            padding: 14px;
            font-size: 14px;
            font-weight: 600;
            background: var(--result-bg);
            color: var(--text-color);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 12px;
        }

        .pin-secondary-btn:hover {
            border-color: var(--accent-color);
            background: var(--accent-color);
            color: white;
            transform: translateY(-2px);
        }

        .pin-close-btn {
            width: 100%;
            padding: 14px;
            font-size: 14px;
            font-weight: 600;
            background: transparent;
            color: var(--text-secondary);
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 12px;
        }

        .pin-close-btn:hover {
            color: var(--text-color);
        }

        .pin-indicator {
            position: fixed;
            top: 10px;
            left: 10px;
            background: var(--accent-color);
            border: none;
            padding: 8px 12px;
            border-radius: 50px;
            cursor: pointer;
            font-size: 16px;
            transition: transform 0.3s ease, background 0.3s ease;
            z-index: 1001;
            box-shadow: 0 2px 10px var(--shadow);
            color: white;
            font-weight: 600;
        }

        .pin-indicator:hover {
            transform: scale(1.1);
        }

        @media (max-width: 768px) {
            .pin-modal-content {
                padding: 30px 25px;
            }

            .pin-input {
                font-size: 20px;
                letter-spacing: 6px;
                padding: 15px;
            }

            .pin-indicator {
                top: 55px;
                left: 10px;
                padding: 6px 10px;
                font-size: 14px;
            }

            body {
                padding: 15px;
                padding-top: 80px;
            }

            .container {
                padding: 20px;
            }

            .main-container {
                margin-top: 20px;
            }

            .theme-toggle {
                position: fixed !important;
                top: 55px !important;
                right: 10px !important;
                padding: 6px 10px;
                font-size: 14px;
                z-index: 1000;
                background: rgba(255, 255, 255, 0.95);
                backdrop-filter: blur(10px);
                border-radius: 6px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            }

            .sound-toggle {
                position: fixed !important;
                top: 55px !important;
                right: 55px !important;
                padding: 6px 10px;
                font-size: 14px;
                z-index: 1000;
                background: rgba(255, 255, 255, 0.95);
                backdrop-filter: blur(10px);
                border-radius: 6px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            }

            .sync-indicator {
                position: fixed !important;
                top: 10px !important;
                right: 10px !important;
                left: 10px !important;
                width: calc(100% - 20px) !important;
                text-align: center;
                font-size: 12px;
                padding: 6px 10px;
                justify-content: center;
                z-index: 1000;
                background: rgba(255, 255, 255, 0.95) !important;
                backdrop-filter: blur(10px);
                border-radius: 6px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            }

            .dark-mode .theme-toggle,
            .dark-mode .sound-toggle,
            .dark-mode .sync-indicator {
                background: rgba(40, 44, 52, 0.95) !important;
            }

            h1 {
                font-size: 22px;
                margin-top: 10px;
            }

            h2 {
                font-size: 18px;
            }

            .timer-display {
                font-size: 36px;
                padding: 25px 15px;
            }

            .time-breakdown {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .action-controls {
                grid-template-columns: 1fr;
            }

            .main-controls {
                grid-template-columns: 1fr;
            }

            button {
                padding: 12px 15px;
                font-size: 13px;
            }

            .summary-content.active {
                grid-template-columns: 1fr;
            }

            .session-actions {
                grid-template-columns: 1fr;
            }

            .result-stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <button class="pin-indicator" id="pinIndicator" title="Manage PIN">üîê PIN</button>
    <button class="theme-toggle" id="themeToggle" title="Toggle theme">üåô</button>
    <button class="sound-toggle" id="soundToggle" title="Toggle sound">üîä</button>
    <div class="sync-indicator" id="syncIndicator">
        <span id="syncIcon">‚òÅÔ∏è</span>
        <span id="syncText">Connecting...</span>
    </div>

    <!-- PIN Authentication Modal -->
    <div id="pinModal" class="pin-modal" style="display: none;">
        <div class="pin-modal-content">
            <h2 style="text-align: center; margin-bottom: 20px; color: var(--text-color);">üîê Secure Your Timer</h2>
            <p style="text-align: center; margin-bottom: 25px; color: var(--text-secondary); line-height: 1.6;">
                Create a PIN to sync your timer across all your devices. Use the same PIN on your phone, tablet, and computer to access your data.
            </p>

            <div id="pinCreateView">
                <input type="tel" id="pinInput" class="pin-input" placeholder="Enter 4-6 digit PIN" maxlength="6" pattern="[0-9]*">
                <button id="pinSubmitBtn" class="pin-submit-btn">Create PIN & Start</button>
            </div>

            <div id="pinSignInView" style="display: none;">
                <input type="tel" id="pinSignInInput" class="pin-input" placeholder="Enter your PIN" maxlength="6" pattern="[0-9]*">
                <button id="pinSignInBtn" class="pin-submit-btn">Sign In</button>
                <button id="pinNewUserBtn" class="pin-secondary-btn">New User? Create PIN</button>
            </div>

            <div id="pinChangeView" style="display: none;">
                <p style="text-align: center; margin-bottom: 15px; color: var(--text-secondary);">Your Current PIN</p>
                <div id="currentPinDisplay" style="text-align: center; font-size: 24px; font-weight: bold; color: var(--accent-color); margin-bottom: 20px;">****</div>
                <button id="pinChangePinBtn" class="pin-secondary-btn">Change PIN</button>
                <button id="pinLogoutBtn" class="pin-secondary-btn">Sign Out</button>
                <button id="pinCloseBtn" class="pin-close-btn">Close</button>
            </div>
        </div>
    </div>

    <div class="main-container">
        <!-- Timer Section -->
        <div class="container timer-container">
            <h1>Freelance Timer</h1>
            <div class="rate-info" id="rateInfo" title="Click to change hourly rate">‚Çπ1,000 per hour</div>
            <div class="last-earned" id="lastEarned" title="Your last session earnings">Last Earned: ‚Çπ0.00</div>

            <div class="status-indicator idle" id="statusIndicator">Ready to Start</div>
            <div class="timer-display" id="timerDisplay">00:00:00</div>

            <div class="time-breakdown">
                <div class="time-stat work">
                    <div class="time-stat-label">Work</div>
                    <div class="time-stat-value" id="workTime">00:00:00</div>
                </div>
                <div class="time-stat break">
                    <div class="time-stat-label">Break</div>
                    <div class="time-stat-value" id="breakTime">00:00:00</div>
                </div>
                <div class="time-stat billable">
                    <div class="time-stat-label">Billable</div>
                    <div class="time-stat-value" id="billableTime">00:00:00</div>
                </div>
            </div>

            <textarea class="notes-area" id="sessionNotes" placeholder="What are you working on?"></textarea>

            <div class="action-controls">
                <button class="work-btn" id="workBtn" disabled>Resume Work</button>
                <button class="break-btn" id="breakBtn" disabled>Take Break</button>
            </div>

            <div class="main-controls">
                <button class="start-btn" id="startBtn">Start</button>
                <button class="stop-btn" id="stopBtn" disabled>Stop</button>
                <button class="reset-btn" id="resetBtn">Reset</button>
                <button class="calculate-btn" id="calculateBtn">Save Session</button>
            </div>

            <div class="result" id="result">
                <div class="result-success-banner">Session Saved Successfully!</div>
                <div class="result-content">
                    <div class="total-amount">
                        <div class="result-label">Amount Earned</div>
                        <div class="result-value" id="totalAmountINR">‚Çπ0.00</div>
                    </div>
                    <div class="result-stats-grid">
                        <div class="result-item">
                            <div class="result-label">Total Time</div>
                            <div class="result-value" id="totalTime">00:00:00</div>
                        </div>
                        <div class="result-item">
                            <div class="result-label">Break Time</div>
                            <div class="result-value" id="resultBreakTime">00:00:00</div>
                        </div>
                        <div class="result-item">
                            <div class="result-label">Billable Time</div>
                            <div class="result-value" id="resultBillableTime">00:00:00</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- History Section -->
        <div class="container history-container">
            <h2>Session History</h2>
            <input type="text" class="search-box" id="searchBox" placeholder="üîç Search sessions...">
            <div class="session-list" id="sessionList">
                <div class="empty-state">No sessions yet</div>
            </div>
            <button class="clear-btn" id="clearHistoryBtn">Clear History</button>
        </div>

        <!-- Summary Section -->
        <div class="container summary-container">
            <h2>Earnings Summary</h2>
            <div class="summary-tabs">
                <button class="tab-btn active" data-tab="daily">Daily</button>
                <button class="tab-btn" data-tab="weekly">Weekly</button>
                <button class="tab-btn" data-tab="monthly">Monthly</button>
            </div>

            <div class="summary-content active" id="daily-summary">
                <div class="summary-stat">
                    <div class="stat-label">Today's Hours</div>
                    <div class="stat-value" id="dailyHours">0h 0m</div>
                </div>
                <div class="summary-stat">
                    <div class="stat-label">Today's Earnings</div>
                    <div class="stat-value" id="dailyEarningsINR">‚Çπ0.00</div>
                </div>
            </div>

            <div class="summary-content" id="weekly-summary">
                <div class="summary-stat">
                    <div class="stat-label">This Week's Hours</div>
                    <div class="stat-value" id="weeklyHours">0h 0m</div>
                </div>
                <div class="summary-stat">
                    <div class="stat-label">This Week's Earnings</div>
                    <div class="stat-value" id="weeklyEarningsINR">‚Çπ0.00</div>
                </div>
            </div>

            <div class="summary-content" id="monthly-summary">
                <div class="summary-stat">
                    <div class="stat-label">This Month's Hours</div>
                    <div class="stat-value" id="monthlyHours">0h 0m</div>
                </div>
                <div class="summary-stat">
                    <div class="stat-label">This Month's Earnings</div>
                    <div class="stat-value" id="monthlyEarningsINR">‚Çπ0.00</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Constants
        window.HOURLY_RATE_INR = parseFloat(localStorage.getItem('hourlyRate')) || 1000;
        const INR_TO_GBP = 0.0095; // Approximate exchange rate

        // Timer Variables
        window.totalSeconds = 0;
        window.workSeconds = 0;
        window.breakSecondsAccumulated = 0;
        let interval = null;
        window.sessionActive = false;
        window.currentStatus = 'idle'; // 'idle', 'working', 'on-break'
        window.soundEnabled = true;
        
        // Timestamp-based timer tracking
        window.timerStartTime = null;
        window.workStartTime = null;
        window.lastBreakStart = null;
        window.totalBreakTime = 0;

        // DOM Elements
        const timerDisplay = document.getElementById('timerDisplay');
        const workTimeDisplay = document.getElementById('workTime');
        const breakTimeDisplay = document.getElementById('breakTime');
        const billableTimeDisplay = document.getElementById('billableTime');
        const statusIndicator = document.getElementById('statusIndicator');

        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const resetBtn = document.getElementById('resetBtn');
        const calculateBtn = document.getElementById('calculateBtn');
        const workBtn = document.getElementById('workBtn');
        const breakBtn = document.getElementById('breakBtn');

        const result = document.getElementById('result');
        const totalTime = document.getElementById('totalTime');
        const resultBreakTime = document.getElementById('resultBreakTime');
        const resultBillableTime = document.getElementById('resultBillableTime');
        const totalAmountINR = document.getElementById('totalAmountINR');
        const totalAmountGBP = document.getElementById('totalAmountGBP');
        const sessionNotes = document.getElementById('sessionNotes');
        const themeToggle = document.getElementById('themeToggle');
        const soundToggle = document.getElementById('soundToggle');
        const rateInfo = document.getElementById('rateInfo');

        // DOM Elements - Session History
        const sessionList = document.getElementById('sessionList');
        const clearHistoryBtn = document.getElementById('clearHistoryBtn');
        const searchBox = document.getElementById('searchBox');

        // Last Earned Functions
        function updateLastEarned(amount) {
            const lastEarnedElement = document.getElementById('lastEarned');
            lastEarnedElement.textContent = `Last Earned: ‚Çπ${amount.toFixed(2)}`;
            
            // Save to localStorage
            localStorage.setItem('lastEarned', amount.toFixed(2));
            
            // Add animation effect
            lastEarnedElement.style.transform = 'scale(1.1)';
            setTimeout(() => {
                lastEarnedElement.style.transform = 'scale(1)';
            }, 300);
        }

        function loadLastEarned() {
            const saved = localStorage.getItem('lastEarned');
            if (saved) {
                document.getElementById('lastEarned').textContent = `Last Earned: ‚Çπ${saved}`;
            }
        }

        // Animate timer restoration
        function animateTimerRestore() {
            updateTimerFromTimestamps(); // Get the target values first
            const targetTotal = window.totalSeconds;
            const targetWork = window.workSeconds + (window.currentStatus === 'working' && window.workStartTime ? 
                Math.floor((new Date() - window.workStartTime) / 1000) : 0);
            const targetBreak = window.breakSecondsAccumulated + (window.currentStatus === 'on-break' && window.lastBreakStart ? 
                Math.floor((new Date() - window.lastBreakStart) / 1000) : 0);

            // Start from zeros
            let currentTotal = 0;
            let currentWork = 0; 
            let currentBreak = 0;

            // Animation duration (2 seconds)
            const duration = 2000;
            const startTime = Date.now();

            function animate() {
                const elapsed = Date.now() - startTime;
                const progress = Math.min(elapsed / duration, 1);
                
                // Easing function for smooth animation
                const easeOutQuart = 1 - Math.pow(1 - progress, 4);
                
                currentTotal = Math.floor(targetTotal * easeOutQuart);
                currentWork = Math.floor(targetWork * easeOutQuart);
                currentBreak = Math.floor(targetBreak * easeOutQuart);

                // Update displays
                timerDisplay.textContent = formatTime(currentTotal);
                workTimeDisplay.textContent = formatTime(currentWork);
                breakTimeDisplay.textContent = formatTime(currentBreak);
                billableTimeDisplay.textContent = formatTime(currentWork);

                if (progress < 1) {
                    requestAnimationFrame(animate);
                } else {
                    // Ensure we end with exact values
                    updateTimerFromTimestamps();
                }
            }

            // Add restore animation styling
            timerDisplay.style.color = '#10b981';
            timerDisplay.style.transform = 'scale(1.05)';
            
            setTimeout(() => {
                timerDisplay.style.color = '';
                timerDisplay.style.transform = '';
            }, duration + 500);

            animate();
        }

        // Hourly Rate Functions
        function updateRateDisplay() {
            rateInfo.textContent = `‚Çπ${window.HOURLY_RATE_INR.toLocaleString()} per hour`;
        }

        function changeHourlyRate() {
            const newRate = prompt('Enter your new hourly rate (‚Çπ):', window.HOURLY_RATE_INR);

            if (newRate !== null && newRate.trim() !== '') {
                const parsedRate = parseFloat(newRate);

                if (isNaN(parsedRate) || parsedRate <= 0) {
                    alert('Please enter a valid positive number');
                    return;
                }

                const oldRate = window.HOURLY_RATE_INR;
                window.HOURLY_RATE_INR = parsedRate;
                localStorage.setItem('hourlyRate', window.HOURLY_RATE_INR);
                updateRateDisplay();
                window.updateSummaries();
                playSound('success');

                // Log action to Firebase
                if (window.logAction) {
                    window.logAction('settings_rate_change', {
                        timestamp: new Date().toISOString(),
                        oldRate: oldRate,
                        newRate: parsedRate
                    });
                }

                // Sync to cloud
                if (window.syncSettingsToCloud) {
                    window.syncSettingsToCloud();
                }
            }
        }

        rateInfo.addEventListener('click', changeHourlyRate);

        // Theme toggle functionality
        function initTheme() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-mode');
                themeToggle.textContent = '‚òÄÔ∏è';
            } else {
                themeToggle.textContent = 'üåô';
            }
        }

        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            themeToggle.textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
            localStorage.setItem('theme', isDark ? 'dark' : 'light');

            // Log action to Firebase
            if (window.logAction) {
                window.logAction('settings_theme_toggle', {
                    timestamp: new Date().toISOString(),
                    theme: isDark ? 'dark' : 'light'
                });
            }

            // Sync to cloud
            if (window.syncSettingsToCloud) {
                window.syncSettingsToCloud();
            }
        }

        themeToggle.addEventListener('click', toggleTheme);
        initTheme();

        // Sound toggle functionality
        function initSound() {
            const savedSound = localStorage.getItem('soundEnabled');
            if (savedSound === 'false') {
                soundEnabled = false;
                soundToggle.textContent = 'üîá';
                soundToggle.classList.add('muted');
            } else {
                soundEnabled = true;
                soundToggle.textContent = 'üîä';
                soundToggle.classList.remove('muted');
            }
        }

        function toggleSound() {
            window.soundEnabled = !window.soundEnabled;
            soundToggle.textContent = window.soundEnabled ? 'üîä' : 'üîá';
            soundToggle.classList.toggle('muted');
            localStorage.setItem('soundEnabled', window.soundEnabled);

            // Log action to Firebase
            if (window.logAction) {
                window.logAction('settings_sound_toggle', {
                    timestamp: new Date().toISOString(),
                    soundEnabled: window.soundEnabled
                });
            }

            // Play test sound
            if (window.soundEnabled) {
                playSound('success');
            }

            // Sync to cloud
            if (window.syncSettingsToCloud) {
                window.syncSettingsToCloud();
            }
        }

        function playSound(type) {
            if (!window.soundEnabled) return;

            try {
                const context = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = context.createOscillator();
                const gainNode = context.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(context.destination);

                oscillator.type = 'sine';

                if (type === 'start') {
                    oscillator.frequency.value = 600;
                    gainNode.gain.setValueAtTime(0.3, context.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, context.currentTime + 0.1);
                    oscillator.start(context.currentTime);
                    oscillator.stop(context.currentTime + 0.1);
                } else if (type === 'stop') {
                    oscillator.frequency.value = 400;
                    gainNode.gain.setValueAtTime(0.3, context.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, context.currentTime + 0.15);
                    oscillator.start(context.currentTime);
                    oscillator.stop(context.currentTime + 0.15);
                } else if (type === 'success') {
                    oscillator.frequency.value = 800;
                    gainNode.gain.setValueAtTime(0.2, context.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, context.currentTime + 0.2);
                    oscillator.start(context.currentTime);
                    oscillator.stop(context.currentTime + 0.2);
                }
            } catch (error) {
                // Silently fail if audio doesn't work
                console.log('Audio not supported');
            }
        }

        soundToggle.addEventListener('click', toggleSound);
        initSound();

        // Time formatting functions
        function formatTime(totalSeconds) {
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const secs = totalSeconds % 60;
            return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
        }

        function formatHoursMinutes(totalSeconds) {
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            return `${hours}h ${minutes}m`;
        }

        // Timer Functions
        function updateTimerFromTimestamps() {
            if (!window.sessionActive || !window.timerStartTime) return;
            
            const now = new Date();
            const totalElapsed = Math.floor((now - window.timerStartTime) / 1000);
            
            // Calculate work time
            let workTime = 0;
            if (window.currentStatus === 'working' && window.workStartTime) {
                const workElapsed = Math.floor((now - window.workStartTime) / 1000);
                workTime = window.workSeconds + workElapsed;
            } else {
                workTime = window.workSeconds;
            }
            
            // Calculate break time
            let breakTime = window.totalBreakTime;
            if (window.currentStatus === 'on-break' && window.lastBreakStart) {
                const currentBreakTime = Math.floor((now - window.lastBreakStart) / 1000);
                breakTime += currentBreakTime;
            }
            
            // Update displays
            timerDisplay.textContent = formatTime(totalElapsed);
            workTimeDisplay.textContent = formatTime(workTime);
            breakTimeDisplay.textContent = formatTime(breakTime);
            billableTimeDisplay.textContent = formatTime(workTime);
            
            // Update global variables for other functions
            window.totalSeconds = totalElapsed;
            window.breakSecondsAccumulated = breakTime;
        }
        
        window.updateAllDisplays = function() {
            updateTimerFromTimestamps();
        }

        function updateStatus(status) {
            window.currentStatus = status;
            statusIndicator.className = 'status-indicator ' + status;

            if (status === 'working') {
                statusIndicator.textContent = 'üü¢ Working';
            } else if (status === 'on-break') {
                statusIndicator.textContent = 'üü† On Break';
            } else {
                statusIndicator.textContent = 'Ready to Start';
            }
        }

        function startSession() {
            if (!window.sessionActive) {
                const now = new Date();
                window.sessionActive = true;
                window.timerStartTime = now;
                window.workStartTime = now;
                window.totalBreakTime = 0;

                updateStatus('working');
                startBtn.disabled = true;
                stopBtn.disabled = false;
                breakBtn.disabled = false;
                workBtn.disabled = true;
                result.classList.remove('show');
                playSound('start');

                // Immediate display update
                updateTimerFromTimestamps();

                // Start the display update interval (more responsive)
                if (interval) {
                    console.warn('‚ö†Ô∏è Clearing existing interval before starting new one');
                    clearInterval(interval);
                }
                interval = setInterval(() => {
                    updateTimerFromTimestamps();
                }, 100);
                console.log('‚úÖ Timer interval started successfully');

                // Log action to Firebase
                if (window.logAction) {
                    window.logAction('timer_start', {
                        timestamp: now.toISOString(),
                        notes: sessionNotes.value,
                        hourlyRate: window.HOURLY_RATE_INR
                    });
                }

                // Immediately sync to cloud
                console.log('Timer started - attempting to sync to Firebase...');
                if (window.syncTimerStateToCloud) {
                    window.syncTimerStateToCloud();
                    console.log('Firebase sync function called');
                } else {
                    console.error('Firebase sync function NOT AVAILABLE!');
                }
            }
        }

        function stopSession() {
            if (window.sessionActive) {
                // Add debugging to track unexpected stops
                console.trace('üõë TIMER STOPPED - Call stack:');
                console.log('Timer stopped at:', new Date().toISOString());

                const now = new Date();

                // Calculate final times
                if (window.currentStatus === 'working' && window.workStartTime) {
                    const workElapsed = Math.floor((now - window.workStartTime) / 1000);
                    window.workSeconds += workElapsed;
                } else if (window.currentStatus === 'on-break' && window.lastBreakStart) {
                    const breakElapsed = Math.floor((now - window.lastBreakStart) / 1000);
                    window.totalBreakTime += breakElapsed;
                }

                window.breakSecondsAccumulated = window.totalBreakTime;

                // Log action to Firebase
                if (window.logAction) {
                    window.logAction('timer_stop', {
                        timestamp: now.toISOString(),
                        totalSeconds: window.totalSeconds,
                        workSeconds: window.workSeconds,
                        breakSeconds: window.breakSecondsAccumulated,
                        notes: sessionNotes.value
                    });
                }

                // Stop the session
                window.sessionActive = false;
                clearInterval(interval);
                updateStatus('idle');
                startBtn.disabled = false;
                stopBtn.disabled = true;
                breakBtn.disabled = true;
                workBtn.disabled = true;
                playSound('stop');

                // Clear timer state from cloud
                if (window.clearTimerStateFromCloud) {
                    window.clearTimerStateFromCloud();
                }
            }
        }

        function takeBreak() {
            if (window.sessionActive && window.currentStatus === 'working') {
                const now = new Date();

                // Save current work time
                if (window.workStartTime) {
                    const workElapsed = Math.floor((now - window.workStartTime) / 1000);
                    window.workSeconds += workElapsed;
                }

                // Start break tracking
                window.lastBreakStart = now;
                updateStatus('on-break');
                workBtn.disabled = false;
                breakBtn.disabled = true;

                // Log action to Firebase
                if (window.logAction) {
                    window.logAction('timer_break_start', {
                        timestamp: now.toISOString(),
                        workSecondsBeforeBreak: window.workSeconds,
                        totalSeconds: window.totalSeconds
                    });
                }

                // Sync to cloud
                if (window.syncTimerStateToCloud) {
                    window.syncTimerStateToCloud();
                }
            }
        }

        function resumeWork() {
            if (window.sessionActive && window.currentStatus === 'on-break') {
                const now = new Date();

                // Save current break time
                if (window.lastBreakStart) {
                    const breakElapsed = Math.floor((now - window.lastBreakStart) / 1000);
                    window.totalBreakTime += breakElapsed;
                    window.lastBreakStart = null;
                }

                // Start work tracking again
                window.workStartTime = now;
                updateStatus('working');
                workBtn.disabled = true;
                breakBtn.disabled = false;

                // Log action to Firebase
                if (window.logAction) {
                    window.logAction('timer_work_resume', {
                        timestamp: now.toISOString(),
                        totalBreakTime: window.totalBreakTime,
                        totalSeconds: window.totalSeconds
                    });
                }

                // Sync to cloud
                if (window.syncTimerStateToCloud) {
                    window.syncTimerStateToCloud();
                }
            }
        }

        function resetTimer(keepResultBanner = false) {
            console.log('Reset timer called, keepResultBanner:', keepResultBanner);

            // Log action to Firebase before resetting
            if (window.logAction && !keepResultBanner) {
                window.logAction('timer_reset', {
                    timestamp: new Date().toISOString(),
                    previousTotalSeconds: window.totalSeconds,
                    previousWorkSeconds: window.workSeconds,
                    previousBreakSeconds: window.breakSecondsAccumulated
                });
            }

            // Stop any active session first
            if (window.sessionActive) {
                window.sessionActive = false;
                if (interval) {
                    clearInterval(interval);
                    interval = null;
                }
            }

            // Reset all timer variables to zero
            window.totalSeconds = 0;
            window.workSeconds = 0;
            window.breakSecondsAccumulated = 0;
            window.timerStartTime = null;
            window.workStartTime = null;
            window.lastBreakStart = null;
            window.totalBreakTime = 0;

            // Reset UI state
            updateStatus('idle');
            document.getElementById('startBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            document.getElementById('breakBtn').disabled = true;
            document.getElementById('workBtn').disabled = true;

            // Clear displays and notes - force update to 00:00:00
            timerDisplay.textContent = '00:00:00';
            workTimeDisplay.textContent = '00:00:00';
            breakTimeDisplay.textContent = '00:00:00';
            billableTimeDisplay.textContent = '00:00:00';

            // Only hide result banner if not preserving it
            if (!keepResultBanner) {
                result.classList.remove('show');
            }

            document.getElementById('sessionNotes').value = '';

            // Clear from cloud
            if (window.clearTimerStateFromCloud) {
                window.clearTimerStateFromCloud();
            }

            // Play reset sound only if manually triggered (not after save)
            if (!keepResultBanner) {
                playSound('success');
            }

            console.log('Timer reset completed - all values set to 0');
        }

        function calculateAmount() {
            if (window.totalSeconds === 0 && !window.sessionActive) {
                alert('Please track some time before saving a session!');
                return;
            }

            // Stop session and calculate final times
            stopSession();
            
            // Ensure we have the latest calculated times
            updateTimerFromTimestamps();

            const billableHours = window.workSeconds / 3600;
            const amountINR = billableHours * window.HOURLY_RATE_INR;
            const amountGBP = amountINR * INR_TO_GBP;

            totalTime.textContent = formatTime(window.totalSeconds);
            resultBreakTime.textContent = formatTime(window.breakSecondsAccumulated);
            resultBillableTime.textContent = formatTime(window.workSeconds);
            totalAmountINR.textContent = `‚Çπ${amountINR.toFixed(2)}`;

            // Save session to history
            saveSession(window.totalSeconds, window.workSeconds, window.breakSecondsAccumulated, amountINR, amountGBP, sessionNotes.value);

            // Update last earned display
            updateLastEarned(amountINR);

            result.classList.add('show');
            playSound('success');

            // Reset timer immediately after saving (but keep result banner visible)
            setTimeout(() => {
                resetTimer(true); // Keep the result banner visible
            }, 1000);
            
            // Hide result banner after 1 minute display
            setTimeout(() => {
                result.classList.remove('show');
            }, 60000);
        }

        // Session History Functions
        function saveSession(totalDuration, workDuration, breakDuration, amountINR, amountGBP, notes) {
            const sessions = getSessionsFromStorage();
            const session = {
                id: Date.now(),
                date: new Date().toISOString(),
                totalDuration: totalDuration,
                workDuration: workDuration,
                breakDuration: breakDuration,
                duration: workDuration, // For backwards compatibility with summaries
                amountINR: amountINR,
                amountGBP: amountGBP,
                notes: notes || 'No description'
            };

            sessions.unshift(session);
            localStorage.setItem('sessions', JSON.stringify(sessions));
            window.displaySessions();
            window.updateSummaries();

            // Log action to Firebase
            if (window.logAction) {
                window.logAction('session_save', {
                    timestamp: new Date().toISOString(),
                    sessionId: session.id,
                    totalDuration: totalDuration,
                    workDuration: workDuration,
                    breakDuration: breakDuration,
                    amountINR: amountINR,
                    hourlyRate: window.HOURLY_RATE_INR,
                    notes: notes || 'No description'
                });
            }

            // Sync to cloud with better error handling
            console.log('Attempting to sync session to Firebase...', session);
            if (window.syncSessionToCloud) {
                try {
                    window.syncSessionToCloud(session);
                    console.log('Session sync initiated successfully');
                } catch (error) {
                    console.error('Failed to initiate session sync:', error);
                }
            } else {
                console.warn('Firebase sync function not available - session only saved locally');
            }
        }

        function getSessionsFromStorage() {
            const stored = localStorage.getItem('sessions');
            return stored ? JSON.parse(stored) : [];
        }

        window.displaySessions = function(searchQuery = '') {
            const sessions = getSessionsFromStorage();

            // Filter sessions based on search query
            const filteredSessions = searchQuery
                ? sessions.filter(session => {
                    const date = new Date(session.date).toLocaleDateString('en-GB');
                    return session.notes.toLowerCase().includes(searchQuery.toLowerCase()) ||
                           date.includes(searchQuery.toLowerCase());
                })
                : sessions;

            if (filteredSessions.length === 0) {
                sessionList.innerHTML = searchQuery
                    ? '<div class="empty-state">No sessions found</div>'
                    : '<div class="empty-state">No sessions yet</div>';
                return;
            }

            // If no search query, show only last 3 sessions with scroll info
            const displaySessions = searchQuery ? filteredSessions : filteredSessions;
            const showScrollInfo = !searchQuery && filteredSessions.length > 3;

            let sessionHTML = '';
            
            // Add scroll info if there are more than 3 sessions and no search
            if (showScrollInfo) {
                sessionHTML += `
                    <div class="scroll-info">
                        <div style="text-align: center; padding: 10px; background: var(--result-bg); border-radius: 8px; margin-bottom: 12px; font-size: 12px; color: var(--text-secondary);">
                            üìú Showing ${displaySessions.length} sessions ‚Ä¢ Scroll to view all
                        </div>
                    </div>
                `;
            }

            sessionHTML += displaySessions.map(session => {
                const date = new Date(session.date);
                const dateStr = date.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
                const timeStr = date.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });

                // Handle both old and new format
                const workTime = session.workDuration !== undefined ? session.workDuration : session.duration;
                const breakTime = session.breakDuration || 0;
                const totalTime = session.totalDuration !== undefined ? session.totalDuration : session.duration;

                return `
                    <div class="session-item" data-session-id="${session.id}">
                        <div class="session-header">
                            <span class="session-date">${dateStr} ${timeStr}</span>
                            <span class="session-time">Billable: ${formatTime(workTime)}</span>
                        </div>
                        <div class="session-notes">${session.notes}</div>
                        ${breakTime > 0 ? `<div class="session-notes" style="font-style: normal; color: var(--text-secondary);">Total: ${formatTime(totalTime)} (Break: ${formatTime(breakTime)})</div>` : ''}
                        <div class="session-earnings">‚Çπ${session.amountINR.toFixed(2)}</div>
                        <div class="session-actions">
                            <button class="edit-session-btn" onclick="editSession(${session.id})">Edit</button>
                            <button class="delete-session-btn" onclick="deleteSession(${session.id})">Delete</button>
                        </div>
                    </div>
                `;
            }).join('');

            sessionList.innerHTML = sessionHTML;
        }

        function deleteSession(sessionId) {
            if (confirm('Are you sure you want to delete this session?')) {
                const sessions = getSessionsFromStorage();
                const sessionToDelete = sessions.find(s => s.id === sessionId);
                const filteredSessions = sessions.filter(s => s.id !== sessionId);
                localStorage.setItem('sessions', JSON.stringify(filteredSessions));
                window.displaySessions(searchBox.value);
                window.updateSummaries();
                playSound('success');

                // Log action to Firebase
                if (window.logAction && sessionToDelete) {
                    window.logAction('session_delete', {
                        timestamp: new Date().toISOString(),
                        sessionId: sessionId,
                        deletedSession: {
                            date: sessionToDelete.date,
                            duration: sessionToDelete.duration,
                            amountINR: sessionToDelete.amountINR,
                            notes: sessionToDelete.notes
                        }
                    });
                }

                // Delete from cloud
                if (window.deleteSessionFromCloud) {
                    window.deleteSessionFromCloud(sessionId);
                }
            }
        }

        function editSession(sessionId) {
            const sessions = getSessionsFromStorage();
            const session = sessions.find(s => s.id === sessionId);

            if (!session) return;

            const oldNotes = session.notes;
            const newNotes = prompt('Edit session notes:', session.notes);

            if (newNotes !== null) {
                session.notes = newNotes || 'No description';
                localStorage.setItem('sessions', JSON.stringify(sessions));
                window.displaySessions(searchBox.value);
                playSound('success');

                // Log action to Firebase
                if (window.logAction) {
                    window.logAction('session_edit', {
                        timestamp: new Date().toISOString(),
                        sessionId: sessionId,
                        oldNotes: oldNotes,
                        newNotes: session.notes
                    });
                }

                // Sync to cloud
                if (window.syncSessionToCloud) {
                    window.syncSessionToCloud(session);
                }
            }
        }

        // Search functionality
        searchBox.addEventListener('input', (e) => {
            window.displaySessions(e.target.value);
        });

        async function clearHistory() {
            if (confirm('Are you sure you want to clear all session history? This will delete ALL sessions from both local storage and Firebase. This cannot be undone.')) {
                // Get all session IDs before clearing
                const sessions = getSessionsFromStorage();

                console.log(`Clearing ${sessions.length} sessions from history and Firebase...`);

                // Log action to Firebase BEFORE clearing
                if (window.logAction && sessions.length > 0) {
                    window.logAction('history_clear_all', {
                        timestamp: new Date().toISOString(),
                        sessionsCount: sessions.length,
                        totalEarnings: sessions.reduce((sum, s) => sum + s.amountINR, 0)
                    });
                }

                // Clear local storage first
                localStorage.removeItem('sessions');
                localStorage.removeItem('lastEarned'); // Clear last earned too
                searchBox.value = '';
                document.getElementById('lastEarned').textContent = 'Last Earned: ‚Çπ0.00'; // Reset display
                window.displaySessions();
                window.updateSummaries();

                // Delete all from Firebase cloud
                if (window.deleteSessionFromCloud && sessions.length > 0) {
                    try {
                        // Delete each session from Firebase
                        const deletePromises = sessions.map(session =>
                            window.deleteSessionFromCloud(session.id)
                        );

                        await Promise.all(deletePromises);
                        console.log('All sessions successfully deleted from Firebase');

                        // Show success message
                        alert(`‚úÖ Successfully cleared ${sessions.length} sessions from both local storage and Firebase!`);
                    } catch (error) {
                        console.error('Error deleting sessions from Firebase:', error);
                        alert('‚ö†Ô∏è Local history cleared, but there was an error deleting some sessions from Firebase. Check console for details.');
                    }
                } else if (sessions.length === 0) {
                    alert('‚úÖ History was already empty!');
                } else {
                    console.log('Firebase delete function not available - only local storage cleared');
                }
            }
        }

        // Summary Functions
        window.updateSummaries = function() {
            const sessions = getSessionsFromStorage();
            const now = new Date();

            // Daily summary
            const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const todaySessions = sessions.filter(s => new Date(s.date) >= todayStart);
            updateSummaryDisplay('daily', todaySessions);

            // Weekly summary
            const weekStart = new Date(now);
            weekStart.setDate(now.getDate() - now.getDay());
            weekStart.setHours(0, 0, 0, 0);
            const weekSessions = sessions.filter(s => new Date(s.date) >= weekStart);
            updateSummaryDisplay('weekly', weekSessions);

            // Monthly summary
            const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
            const monthSessions = sessions.filter(s => new Date(s.date) >= monthStart);
            updateSummaryDisplay('monthly', monthSessions);
        }

        function updateSummaryDisplay(period, sessions) {
            const totalSeconds = sessions.reduce((sum, s) => sum + s.duration, 0);
            const totalINR = sessions.reduce((sum, s) => sum + s.amountINR, 0);
            const totalGBP = sessions.reduce((sum, s) => sum + s.amountGBP, 0);

            document.getElementById(`${period}Hours`).textContent = formatHoursMinutes(totalSeconds);
            document.getElementById(`${period}EarningsINR`).textContent = `‚Çπ${totalINR.toFixed(2)}`;
        }

        // Tab switching
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const tab = btn.dataset.tab;

                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.summary-content').forEach(c => c.classList.remove('active'));

                btn.classList.add('active');
                document.getElementById(`${tab}-summary`).classList.add('active');
            });
        });

        // Event Listeners
        startBtn.addEventListener('click', startSession);
        stopBtn.addEventListener('click', stopSession);
        resetBtn.addEventListener('click', function(e) {
            console.log('Reset button event fired');
            e.preventDefault();
            e.stopPropagation();
            resetTimer();
        });
        calculateBtn.addEventListener('click', calculateAmount);
        workBtn.addEventListener('click', resumeWork);
        breakBtn.addEventListener('click', takeBreak);
        clearHistoryBtn.addEventListener('click', clearHistory);

        // Initialize
        console.log('Initializing timer application...');
        try {
            updateRateDisplay();
            loadLastEarned();
            window.displaySessions();
            window.updateSummaries();
            window.updateAllDisplays();

            // Backup reset button handler
            const backupResetBtn = document.getElementById('resetBtn');
            if (backupResetBtn) {
                backupResetBtn.onclick = function() {
                    console.log('Backup reset handler triggered');
                    resetTimer();
                };
                console.log('Reset button found and backup handler attached');
            } else {
                console.error('Reset button not found!');
            }

            // ============================================
            // NOTES CHANGE TRACKING
            // ============================================
            let lastNotesValue = sessionNotes.value;
            let notesTimeout;

            sessionNotes.addEventListener('input', (e) => {
                // Debounce notes changes - log after 2 seconds of no typing
                clearTimeout(notesTimeout);
                notesTimeout = setTimeout(() => {
                    const newValue = e.target.value;
                    if (newValue !== lastNotesValue) {
                        if (window.logAction) {
                            window.logAction('notes_change', {
                                timestamp: new Date().toISOString(),
                                previousLength: lastNotesValue.length,
                                newLength: newValue.length,
                                preview: newValue.substring(0, 100)
                            });
                        }
                        lastNotesValue = newValue;

                        // Also sync timer state to cloud
                        if (window.syncTimerStateToCloud && window.sessionActive) {
                            window.syncTimerStateToCloud();
                        }
                    }
                }, 2000);
            });

            // ============================================
            // AUTOMATIC STATE SNAPSHOTS
            // ============================================
            // Take state snapshots every 60 seconds for active sessions
            setInterval(() => {
                if (window.sessionActive && window.logTimerStateSnapshot) {
                    window.logTimerStateSnapshot();
                    console.log('üì∏ Automatic state snapshot taken');
                }
            }, 60000); // Every 60 seconds

            console.log('Timer application initialized successfully');
            console.log('‚úÖ Action logging system active');
            console.log('‚úÖ Notes tracking enabled');
            console.log('‚úÖ Automatic state snapshots enabled (every 60s)');
        } catch (error) {
            console.error('Error initializing timer application:', error);
        }
    </script>

    <!-- Firebase Integration -->
    <script type="module">
        // Import Firebase SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDoc, getDocs, deleteDoc, onSnapshot, serverTimestamp, query, orderBy } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCZ3Z3WNs6Xf0P5DvJpb1iC-VUpdgivOJ8",
            authDomain: "freelance-372d0.firebaseapp.com",
            projectId: "freelance-372d0",
            storageBucket: "freelance-372d0.firebasestorage.app",
            messagingSenderId: "87901216400",
            appId: "1:87901216400:web:a087e17b29c6af56fc8215",
            measurementId: "G-BBD0VVKWLG"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Sync state
        let userId = null;
        let isOnline = navigator.onLine;
        let unsubscribeSessions = null;
        let unsubscribeTimerState = null;

        // DOM elements
        const syncIndicator = document.getElementById('syncIndicator');
        const syncIcon = document.getElementById('syncIcon');
        const syncText = document.getElementById('syncText');
        const pinModal = document.getElementById('pinModal');
        const pinIndicator = document.getElementById('pinIndicator');
        const pinInput = document.getElementById('pinInput');
        const pinSubmitBtn = document.getElementById('pinSubmitBtn');
        const pinSignInInput = document.getElementById('pinSignInInput');
        const pinSignInBtn = document.getElementById('pinSignInBtn');
        const pinNewUserBtn = document.getElementById('pinNewUserBtn');
        const pinCreateView = document.getElementById('pinCreateView');
        const pinSignInView = document.getElementById('pinSignInView');
        const pinChangeView = document.getElementById('pinChangeView');
        const currentPinDisplay = document.getElementById('currentPinDisplay');
        const pinChangePinBtn = document.getElementById('pinChangePinBtn');
        const pinLogoutBtn = document.getElementById('pinLogoutBtn');
        const pinCloseBtn = document.getElementById('pinCloseBtn');

        // PIN helper functions
        function pinToEmail(pin) {
            return `pin${pin}@timer.local`;
        }

        function showPinModal(view = 'create') {
            pinModal.style.display = 'flex';
            pinCreateView.style.display = 'none';
            pinSignInView.style.display = 'none';
            pinChangeView.style.display = 'none';

            if (view === 'create') {
                pinCreateView.style.display = 'block';
                pinInput.value = '';
                setTimeout(() => pinInput.focus(), 100);
            } else if (view === 'signin') {
                pinSignInView.style.display = 'block';
                pinSignInInput.value = '';
                setTimeout(() => pinSignInInput.focus(), 100);
            } else if (view === 'manage') {
                pinChangeView.style.display = 'block';
                const savedPin = localStorage.getItem('userPin');
                currentPinDisplay.textContent = savedPin || '****';
            }
        }

        function hidePinModal() {
            pinModal.style.display = 'none';
        }

        // PIN Modal Event Listeners
        pinIndicator.addEventListener('click', () => {
            if (userId) {
                showPinModal('manage');
            } else {
                showPinModal('signin');
            }
        });

        pinSubmitBtn.addEventListener('click', () => createPinAndSignIn());
        pinInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') createPinAndSignIn();
        });

        pinSignInBtn.addEventListener('click', () => signInWithPin());
        pinSignInInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') signInWithPin();
        });

        pinNewUserBtn.addEventListener('click', () => showPinModal('create'));

        pinChangePinBtn.addEventListener('click', () => {
            hidePinModal();
            setTimeout(() => {
                const newPin = prompt('Enter your new PIN (4-6 digits):');
                if (newPin && /^\d{4,6}$/.test(newPin)) {
                    changePinInFirebase(newPin);
                } else if (newPin) {
                    alert('PIN must be 4-6 digits');
                }
            }, 300);
        });

        pinLogoutBtn.addEventListener('click', () => {
            if (confirm('Are you sure you want to sign out? Your data will remain safe in the cloud.')) {
                signOutUser();
            }
        });

        pinCloseBtn.addEventListener('click', () => hidePinModal());

        // Create PIN and sign in
        async function createPinAndSignIn() {
            const pin = pinInput.value.trim();

            if (!/^\d{4,6}$/.test(pin)) {
                alert('Please enter a 4-6 digit PIN');
                return;
            }

            try {
                updateSyncStatus('syncing', 'Creating account...');
                console.log('üîê Creating new account with PIN...');

                const email = pinToEmail(pin);
                const password = pin + '_secure_' + pin; // More secure password

                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                userId = userCredential.user.uid;

                console.log('‚úÖ Account created successfully!', userId);

                localStorage.setItem('userPin', pin);
                localStorage.setItem('firebaseUserId', userId);

                hidePinModal();
                updateSyncStatus('synced', 'Connected');

                // Migrate local data to new account
                await migrateLocalDataToCloud();

                // Set up real-time listeners
                setupRealtimeSync();

                alert('‚úÖ PIN created successfully! Use this PIN on all your devices to sync.');
            } catch (error) {
                console.error('‚ùå Error creating account:', error);

                if (error.code === 'auth/email-already-in-use') {
                    // PIN already exists, try to sign in
                    console.log('PIN already exists, attempting sign in...');
                    pinInput.value = '';
                    showPinModal('signin');
                    pinSignInInput.value = pin;
                    alert('This PIN already exists. Please sign in instead.');
                } else {
                    alert('Error creating PIN: ' + error.message);
                    updateSyncStatus('offline', 'Failed');
                }
            }
        }

        // Sign in with PIN
        async function signInWithPin() {
            const pin = pinSignInInput.value.trim();

            if (!/^\d{4,6}$/.test(pin)) {
                alert('Please enter a valid 4-6 digit PIN');
                return;
            }

            try {
                updateSyncStatus('syncing', 'Signing in...');
                console.log('üîê Signing in with PIN...');

                const email = pinToEmail(pin);
                const password = pin + '_secure_' + pin;

                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                userId = userCredential.user.uid;

                console.log('‚úÖ Signed in successfully!', userId);

                localStorage.setItem('userPin', pin);
                localStorage.setItem('firebaseUserId', userId);

                hidePinModal();
                updateSyncStatus('synced', 'Connected');

                // Load data from cloud
                await syncFromCloud();

                // Set up real-time listeners
                setupRealtimeSync();

            } catch (error) {
                console.error('‚ùå Error signing in:', error);

                if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                    alert('‚ùå Incorrect PIN. Please try again or create a new PIN.');
                } else {
                    alert('Error signing in: ' + error.message);
                }

                updateSyncStatus('offline', 'Sign in failed');
            }
        }

        // Change PIN
        async function changePinInFirebase(newPin) {
            try {
                alert('To change your PIN, please:\n1. Sign out\n2. Create a new PIN\n3. Manually transfer your data\n\nThis limitation ensures your data security.');
            } catch (error) {
                console.error('Error changing PIN:', error);
            }
        }

        // Sign out
        async function signOutUser() {
            try {
                await signOut(auth);
                userId = null;
                localStorage.removeItem('userPin');
                localStorage.removeItem('firebaseUserId');

                updateSyncStatus('offline', 'Signed out');
                hidePinModal();

                // Optionally clear local data
                if (confirm('Do you want to clear your local data as well?')) {
                    localStorage.clear();
                    location.reload();
                } else {
                    location.reload();
                }
            } catch (error) {
                console.error('Error signing out:', error);
                alert('Error signing out: ' + error.message);
            }
        }

        // Update sync indicator
        function updateSyncStatus(status, message) {
            syncIndicator.className = 'sync-indicator ' + status;
            syncText.textContent = message;

            if (status === 'synced') {
                syncIcon.textContent = '‚úì';
            } else if (status === 'syncing') {
                syncIcon.textContent = '‚ü≥';
            } else if (status === 'offline') {
                syncIcon.textContent = '‚úï';
            } else {
                syncIcon.textContent = '‚òÅÔ∏è';
            }
        }

        // ============================================
        // COMPREHENSIVE ACTION LOGGING SYSTEM
        // ============================================

        /**
         * Logs every action to Firebase for complete state tracking
         * @param {string} actionType - Type of action (e.g., 'timer_start', 'button_click')
         * @param {object} actionData - Additional data about the action
         */
        async function logAction(actionType, actionData = {}) {
            if (!userId || !isOnline) {
                console.log('üìù [Offline] Action logged locally:', actionType, actionData);
                return;
            }

            try {
                const actionId = Date.now().toString() + '_' + Math.random().toString(36).substr(2, 9);

                const actionLog = {
                    id: actionId,
                    userId: userId,
                    type: actionType,
                    data: actionData,
                    timestamp: new Date().toISOString(),
                    serverTimestamp: serverTimestamp(),
                    device: {
                        userAgent: navigator.userAgent,
                        platform: navigator.platform,
                        language: navigator.language,
                        screenWidth: window.screen.width,
                        screenHeight: window.screen.height
                    }
                };

                // Store action in Firebase
                await setDoc(doc(db, `users/${userId}/actions`, actionId), actionLog);

                console.log('‚úÖ Action logged to Firebase:', actionType, actionData);
            } catch (error) {
                console.error('‚ùå Error logging action:', error);
            }
        }

        /**
         * Logs timer state snapshots for complete timeline reconstruction
         */
        async function logTimerStateSnapshot() {
            if (!userId || !isOnline) return;

            try {
                const stateSnapshot = {
                    sessionActive: window.sessionActive,
                    currentStatus: window.currentStatus,
                    totalSeconds: window.totalSeconds,
                    workSeconds: window.workSeconds,
                    breakSecondsAccumulated: window.breakSecondsAccumulated,
                    timerStartTime: window.timerStartTime ? window.timerStartTime.toISOString() : null,
                    workStartTime: window.workStartTime ? window.workStartTime.toISOString() : null,
                    lastBreakStart: window.lastBreakStart ? window.lastBreakStart.toISOString() : null,
                    totalBreakTime: window.totalBreakTime,
                    notes: document.getElementById('sessionNotes')?.value || ''
                };

                await logAction('timer_state_snapshot', stateSnapshot);
            } catch (error) {
                console.error('‚ùå Error logging timer snapshot:', error);
            }
        }

        // Store action logging globally for access from main script
        window.logAction = logAction;
        window.logTimerStateSnapshot = logTimerStateSnapshot;

        // Monitor online/offline status
        window.addEventListener('online', () => {
            isOnline = true;
            updateSyncStatus('syncing', 'Syncing...');
            syncAllData();
        });

        window.addEventListener('offline', () => {
            isOnline = false;
            updateSyncStatus('offline', 'Offline');
        });

        // Authenticate user with PIN
        async function authenticateUser() {
            try {
                console.log('üîê Starting authentication...');
                console.log('üåç Current domain:', window.location.hostname);

                // Check if user has saved PIN
                const savedPin = localStorage.getItem('userPin');

                if (savedPin && /^\d{4,6}$/.test(savedPin)) {
                    console.log('üì± Found saved PIN, attempting auto sign-in...');
                    updateSyncStatus('syncing', 'Signing in...');

                    try {
                        const email = pinToEmail(savedPin);
                        const password = savedPin + '_secure_' + savedPin;

                        const userCredential = await signInWithEmailAndPassword(auth, email, password);
                        userId = userCredential.user.uid;

                        console.log('‚úÖ Auto sign-in successful!', userId);
                        localStorage.setItem('firebaseUserId', userId);
                        updateSyncStatus('synced', 'Connected');

                        // Load data from cloud
                        console.log('üì• Syncing from cloud...');
                        await syncFromCloud();

                        // Set up real-time listeners
                        console.log('üëÇ Setting up real-time listeners...');
                        setupRealtimeSync();
                        console.log('‚úÖ Firebase initialization complete!');

                    } catch (signInError) {
                        console.error('‚ùå Auto sign-in failed:', signInError);

                        // Clear invalid PIN
                        localStorage.removeItem('userPin');
                        localStorage.removeItem('firebaseUserId');

                        // Show PIN modal
                        updateSyncStatus('offline', 'Sign in required');
                        showPinModal('signin');
                    }
                } else {
                    // No saved PIN, show create PIN modal
                    console.log('‚ÑπÔ∏è No saved PIN found, showing PIN creation modal...');
                    updateSyncStatus('offline', 'Not signed in');

                    // Check if we should auto-show the modal or wait for user
                    const hasLocalData = localStorage.getItem('sessions') || localStorage.getItem('hourlyRate');

                    if (hasLocalData) {
                        // Has local data, show signin option first
                        showPinModal('signin');
                    } else {
                        // New user, show create option
                        showPinModal('create');
                    }
                }

            } catch (error) {
                console.error('‚ùå Authentication Error:', error);
                console.error('Error Code:', error.code);
                console.error('Error Message:', error.message);
                console.error('Error Stack:', error.stack);

                updateSyncStatus('offline', 'Auth Failed');

                // Show specific error messages
                let errorMsg = 'Authentication failed: ';
                if (error.code === 'auth/network-request-failed') {
                    errorMsg += 'Network connection issue';
                } else if (error.code === 'auth/api-key-not-valid') {
                    errorMsg += 'Invalid API key configuration';
                } else if (error.code === 'auth/project-not-found') {
                    errorMsg += 'Firebase project not found';
                } else if (error.code === 'auth/unauthorized-domain') {
                    errorMsg += 'Domain not authorized in Firebase. Add "' + window.location.hostname + '" to Firebase Console > Authentication > Settings > Authorized domains';
                } else {
                    errorMsg += error.message;
                }

                console.warn('‚ö†Ô∏è', errorMsg);

                // Show PIN modal anyway for offline mode
                showPinModal('create');
            }
        }

        // Migrate existing localStorage data to cloud
        async function migrateLocalDataToCloud() {
            try {
                updateSyncStatus('syncing', 'Migrating data...');

                // Migrate sessions
                const localSessions = localStorage.getItem('sessions');
                if (localSessions) {
                    const sessions = JSON.parse(localSessions);
                    for (const session of sessions) {
                        await setDoc(doc(db, `users/${userId}/sessions`, session.id.toString()), session);
                    }
                }

                // Migrate settings
                const settings = {
                    hourlyRate: parseFloat(localStorage.getItem('hourlyRate')) || 1000,
                    theme: localStorage.getItem('theme') || 'light',
                    soundEnabled: localStorage.getItem('soundEnabled') !== 'false'
                };
                await setDoc(doc(db, `users/${userId}/settings`, 'preferences'), settings);

                updateSyncStatus('synced', 'Synced');
            } catch (error) {
                console.error('Migration error:', error);
            }
        }

        // Sync sessions to cloud
        window.syncSessionToCloud = async function(session) {
            console.log('syncSessionToCloud called with:', session);
            console.log('userId:', userId, 'isOnline:', isOnline);
            
            if (!userId) {
                console.error('Cannot sync session: No Firebase userId available');
                return;
            }
            
            if (!isOnline) {
                console.warn('Cannot sync session: Currently offline');
                return;
            }

            try {
                console.log('Attempting to save session to Firebase...');
                await setDoc(doc(db, `users/${userId}/sessions`, session.id.toString()), {
                    ...session,
                    syncedAt: serverTimestamp()
                });
                console.log('‚úÖ Session successfully synced to Firebase!', session.id);
                updateSyncStatus('synced', 'Synced');
            } catch (error) {
                console.error('‚ùå Error syncing session to Firebase:', error);
                console.error('Error details:', error.message, error.code);
                updateSyncStatus('offline', 'Sync failed');
            }
        };

        // Sync settings to cloud
        window.syncSettingsToCloud = async function() {
            if (!userId || !isOnline) return;

            try {
                const settings = {
                    hourlyRate: window.HOURLY_RATE_INR || 1000,
                    theme: document.body.classList.contains('dark-mode') ? 'dark' : 'light',
                    soundEnabled: window.soundEnabled !== undefined ? window.soundEnabled : true,
                    updatedAt: serverTimestamp()
                };

                await setDoc(doc(db, `users/${userId}/settings`, 'preferences'), settings);
                updateSyncStatus('synced', 'Synced');
            } catch (error) {
                console.error('Error syncing settings:', error);
            }
        };

        // Sync timer state to cloud (auto-save current session)
        window.syncTimerStateToCloud = async function() {
            console.log('syncTimerStateToCloud called');
            console.log('userId:', userId, 'isOnline:', isOnline);
            
            if (!userId) {
                console.error('‚ùå Cannot sync timer state: No Firebase userId');
                return;
            }
            
            if (!isOnline) {
                console.warn('‚ö†Ô∏è Cannot sync timer state: Offline');
                return;
            }

            // Build timer state object
            const timerState = {
                sessionActive: window.sessionActive || false,
                currentStatus: window.currentStatus || 'idle',
                timerStartTime: window.timerStartTime ? window.timerStartTime.toISOString() : null,
                workStartTime: window.workStartTime ? window.workStartTime.toISOString() : null,
                lastBreakStart: window.lastBreakStart ? window.lastBreakStart.toISOString() : null,
                workSeconds: window.workSeconds || 0,
                totalBreakTime: window.totalBreakTime || 0,
                notes: document.getElementById('sessionNotes')?.value || '',
                updatedAt: serverTimestamp()
            };

            console.log('üîÑ Syncing timer state to Firebase:', timerState);

            // Non-blocking sync
            setDoc(doc(db, `users/${userId}/state`, 'currentTimer'), timerState)
                .then(() => {
                    console.log('‚úÖ Timer state successfully synced to Firebase!');
                    updateSyncStatus('synced', 'Timer Synced');
                })
                .catch(error => {
                    console.error('‚ùå Error syncing timer state to Firebase:', error);
                    updateSyncStatus('offline', 'Sync Failed');
                });
        };

        // Load data from cloud
        async function syncFromCloud() {
            if (!userId) {
                console.warn('‚ö†Ô∏è Cannot sync from cloud: No userId');
                return;
            }

            try {
                console.log('üì• Starting syncFromCloud for user:', userId);
                updateSyncStatus('syncing', 'Loading data...');

                // Load settings
                console.log('‚öôÔ∏è Loading settings from Firestore...');
                const settingsDoc = await getDoc(doc(db, `users/${userId}/settings`, 'preferences'));
                if (settingsDoc.exists()) {
                    const settings = settingsDoc.data();
                    console.log('‚úÖ Settings loaded:', settings);

                    // Apply settings
                    if (settings.hourlyRate) {
                        window.HOURLY_RATE_INR = settings.hourlyRate;
                        localStorage.setItem('hourlyRate', settings.hourlyRate);
                        document.getElementById('rateInfo').textContent = `‚Çπ${settings.hourlyRate.toLocaleString()} per hour`;
                    }

                    if (settings.theme) {
                        const isDark = settings.theme === 'dark';
                        if (isDark !== document.body.classList.contains('dark-mode')) {
                            document.body.classList.toggle('dark-mode');
                            document.getElementById('themeToggle').textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
                        }
                    }

                    if (settings.soundEnabled !== undefined) {
                        window.soundEnabled = settings.soundEnabled;
                        const soundToggle = document.getElementById('soundToggle');
                        soundToggle.textContent = settings.soundEnabled ? 'üîä' : 'üîá';
                        soundToggle.classList.toggle('muted', !settings.soundEnabled);
                    }
                } else {
                    console.log('‚ÑπÔ∏è No settings found in cloud');
                }

                // Load sessions
                console.log('üìö Loading sessions from Firestore...');
                const sessionsQuery = query(collection(db, `users/${userId}/sessions`), orderBy('date', 'desc'));
                const sessionsSnapshot = await getDocs(sessionsQuery);
                const cloudSessions = [];
                sessionsSnapshot.forEach((doc) => {
                    cloudSessions.push(doc.data());
                });
                console.log(`‚úÖ Loaded ${cloudSessions.length} sessions from cloud`);

                if (cloudSessions.length > 0) {
                    localStorage.setItem('sessions', JSON.stringify(cloudSessions));
                    window.displaySessions();
                    window.updateSummaries();
                    console.log('‚úÖ Sessions synced to localStorage and UI updated');
                } else {
                    console.log('‚ÑπÔ∏è No sessions found in cloud');
                }

                // Load timer state
                console.log('‚è±Ô∏è Loading timer state from Firestore...');
                const timerStateDoc = await getDoc(doc(db, `users/${userId}/state`, 'currentTimer'));
                if (timerStateDoc.exists()) {
                    const timerState = timerStateDoc.data();
                    console.log('‚úÖ Timer state loaded:', timerState);

                    // Automatically restore active session
                    if (timerState.sessionActive && timerState.timerStartTime) {
                        console.log('üîÑ Restoring active timer session from Firebase...');
                        console.log('üìä Timer state details:', {
                            sessionActive: timerState.sessionActive,
                            currentStatus: timerState.currentStatus,
                            timerStartTime: timerState.timerStartTime,
                            workSeconds: timerState.workSeconds,
                            totalBreakTime: timerState.totalBreakTime
                        });

                        // Restore timer state
                        window.sessionActive = true;
                        window.currentStatus = timerState.currentStatus || 'working';
                        window.timerStartTime = timerState.timerStartTime ? new Date(timerState.timerStartTime) : null;
                        window.workStartTime = timerState.workStartTime ? new Date(timerState.workStartTime) : null;
                        window.lastBreakStart = timerState.lastBreakStart ? new Date(timerState.lastBreakStart) : null;
                        window.workSeconds = timerState.workSeconds || 0;
                        window.totalBreakTime = timerState.totalBreakTime || 0;
                        document.getElementById('sessionNotes').value = timerState.notes || '';

                        // Update UI
                        updateStatus(window.currentStatus);
                        document.getElementById('startBtn').disabled = true;
                        document.getElementById('stopBtn').disabled = false;

                        if (window.currentStatus === 'working') {
                            document.getElementById('breakBtn').disabled = false;
                            document.getElementById('workBtn').disabled = true;
                        } else if (window.currentStatus === 'on-break') {
                            document.getElementById('breakBtn').disabled = true;
                            document.getElementById('workBtn').disabled = false;
                        }

                        // Start the display update interval (more responsive)
                        if (interval) {
                            console.warn('‚ö†Ô∏è Clearing existing interval during Firebase restore');
                            clearInterval(interval);
                        }
                        interval = setInterval(() => {
                            updateTimerFromTimestamps();
                        }, 100);
                        console.log('‚úÖ Timer interval restored from Firebase');

                        // Animate timer restoration with counting effect
                        animateTimerRestore();

                        console.log('‚úÖ Timer session restored successfully!');
                    } else if (!timerState.sessionActive && timerState.timerStartTime) {
                        console.log('üóëÔ∏è Clearing completed session from cloud');
                        await deleteDoc(doc(db, `users/${userId}/state`, 'currentTimer'));
                    } else {
                        console.log('‚ÑπÔ∏è No active timer session to restore');
                    }
                } else {
                    console.log('‚ÑπÔ∏è No timer state found in cloud');
                }

                console.log('‚úÖ syncFromCloud completed successfully');
                updateSyncStatus('synced', 'Synced');
            } catch (error) {
                console.error('‚ùå Error loading from cloud:', error);
                console.error('Error code:', error.code);
                console.error('Error message:', error.message);
                updateSyncStatus('offline', 'Sync failed');
            }
        }

        // Set up real-time sync listeners
        function setupRealtimeSync() {
            if (!userId) {
                console.error('‚ö†Ô∏è Cannot setup real-time sync: No userId');
                return;
            }

            console.log('üëÇ Setting up real-time listeners for user:', userId);

            // ============================================
            // 1. REAL-TIME TIMER STATE SYNC
            // ============================================
            console.log('üîÑ Setting up timer state listener...');
            unsubscribeTimerState = onSnapshot(
                doc(db, `users/${userId}/state`, 'currentTimer'),
                (docSnapshot) => {
                    if (!docSnapshot.exists()) {
                        console.log('‚ÑπÔ∏è No active timer state in cloud');
                        return;
                    }

                    const timerState = docSnapshot.data();
                    console.log('üîî Timer state update received from cloud:', timerState);

                    // Only update if this is from another device (not our own update)
                    const cloudTimestamp = timerState.timerStartTime;
                    const localTimestamp = window.timerStartTime ? window.timerStartTime.toISOString() : null;

                    // If we have a local timer running and cloud timer is different, cloud takes precedence
                    if (timerState.sessionActive && timerState.timerStartTime) {
                        const cloudTime = new Date(timerState.timerStartTime).getTime();
                        const localTime = window.timerStartTime ? window.timerStartTime.getTime() : 0;

                        // Only update if cloud state is different (allowing 1 second tolerance)
                        if (Math.abs(cloudTime - localTime) > 1000 || window.currentStatus !== timerState.currentStatus) {
                            console.log('üîÑ Syncing timer from another device...');
                            console.log('Cloud time:', cloudTime, 'Local time:', localTime);

                            // Stop current session if running
                            if (window.sessionActive) {
                                clearInterval(interval);
                            }

                            // Restore timer state from cloud
                            window.sessionActive = true;
                            window.currentStatus = timerState.currentStatus || 'working';
                            window.timerStartTime = timerState.timerStartTime ? new Date(timerState.timerStartTime) : null;
                            window.workStartTime = timerState.workStartTime ? new Date(timerState.workStartTime) : null;
                            window.lastBreakStart = timerState.lastBreakStart ? new Date(timerState.lastBreakStart) : null;
                            window.workSeconds = timerState.workSeconds || 0;
                            window.totalBreakTime = timerState.totalBreakTime || 0;
                            document.getElementById('sessionNotes').value = timerState.notes || '';

                            // Update UI
                            updateStatus(window.currentStatus);
                            document.getElementById('startBtn').disabled = true;
                            document.getElementById('stopBtn').disabled = false;

                            if (window.currentStatus === 'working') {
                                document.getElementById('breakBtn').disabled = false;
                                document.getElementById('workBtn').disabled = true;
                            } else if (window.currentStatus === 'on-break') {
                                document.getElementById('breakBtn').disabled = true;
                                document.getElementById('workBtn').disabled = false;
                            }

                            // Start the timer interval
                            if (interval) clearInterval(interval);
                            interval = setInterval(() => {
                                updateTimerFromTimestamps();
                            }, 100);

                            // Animate restoration
                            animateTimerRestore();

                            console.log('‚úÖ Timer synced from cloud successfully!');

                            // Show notification
                            updateSyncStatus('synced', 'Timer synced!');
                            setTimeout(() => updateSyncStatus('synced', 'Synced'), 2000);
                        }
                    } else if (!timerState.sessionActive && window.sessionActive) {
                        // Timer was stopped on another device
                        console.log('üõë Timer stopped on another device, stopping locally...');
                        stopSession();
                        console.log('‚úÖ Local timer stopped to match cloud state');
                    }
                },
                (error) => {
                    console.error('‚ùå Error in timer state listener:', error);
                }
            );

            // ============================================
            // 2. REAL-TIME SESSIONS SYNC
            // ============================================
            console.log('üìö Setting up sessions listener...');
            unsubscribeSessions = onSnapshot(
                query(collection(db, `users/${userId}/sessions`), orderBy('date', 'desc')),
                (snapshot) => {
                    console.log('üîî Sessions update received from cloud');
                    const sessions = [];
                    snapshot.forEach((doc) => {
                        sessions.push(doc.data());
                    });

                    console.log(`üì• Synced ${sessions.length} sessions from cloud`);

                    // Update localStorage and UI
                    localStorage.setItem('sessions', JSON.stringify(sessions));
                    window.displaySessions();
                    window.updateSummaries();

                    updateSyncStatus('synced', 'Synced');
                },
                (error) => {
                    console.error('‚ùå Error in sessions listener:', error);
                }
            );

            // ============================================
            // 3. REAL-TIME SETTINGS SYNC
            // ============================================
            console.log('‚öôÔ∏è Setting up settings listener...');
            const unsubscribeSettings = onSnapshot(
                doc(db, `users/${userId}/settings`, 'preferences'),
                (docSnapshot) => {
                    if (!docSnapshot.exists()) {
                        console.log('‚ÑπÔ∏è No settings found in cloud');
                        return;
                    }

                    const settings = docSnapshot.data();
                    console.log('üîî Settings update received from cloud:', settings);

                    // Update hourly rate
                    if (settings.hourlyRate && settings.hourlyRate !== window.HOURLY_RATE_INR) {
                        console.log(`üí∞ Hourly rate updated: ‚Çπ${settings.hourlyRate}`);
                        window.HOURLY_RATE_INR = settings.hourlyRate;
                        localStorage.setItem('hourlyRate', settings.hourlyRate);
                        document.getElementById('rateInfo').textContent = `‚Çπ${settings.hourlyRate.toLocaleString()} per hour`;
                        window.updateSummaries();
                    }

                    // Update theme
                    if (settings.theme) {
                        const isDark = settings.theme === 'dark';
                        const currentlyDark = document.body.classList.contains('dark-mode');
                        if (isDark !== currentlyDark) {
                            console.log(`üé® Theme updated: ${settings.theme}`);
                            document.body.classList.toggle('dark-mode');
                            document.getElementById('themeToggle').textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
                            localStorage.setItem('theme', settings.theme);
                        }
                    }

                    // Update sound
                    if (settings.soundEnabled !== undefined && settings.soundEnabled !== window.soundEnabled) {
                        console.log(`üîä Sound updated: ${settings.soundEnabled}`);
                        window.soundEnabled = settings.soundEnabled;
                        const soundToggle = document.getElementById('soundToggle');
                        soundToggle.textContent = settings.soundEnabled ? 'üîä' : 'üîá';
                        soundToggle.classList.toggle('muted', !settings.soundEnabled);
                        localStorage.setItem('soundEnabled', settings.soundEnabled);
                    }
                },
                (error) => {
                    console.error('‚ùå Error in settings listener:', error);
                }
            );

            console.log('‚úÖ All real-time listeners active!');
            console.log('üì° Watching for changes from other devices...');
        }

        // Sync all data
        async function syncAllData() {
            await syncSettingsToCloud();
            await syncTimerStateToCloud();

            // Sync all sessions
            const sessions = JSON.parse(localStorage.getItem('sessions') || '[]');
            for (const session of sessions) {
                await syncSessionToCloud(session);
            }
        }

        // Clear timer state from cloud
        window.clearTimerStateFromCloud = async function() {
            if (!userId || !isOnline) return;

            try {
                await deleteDoc(doc(db, `users/${userId}/state`, 'currentTimer'));
                console.log('Timer state cleared from cloud');
            } catch (error) {
                console.error('Error clearing timer state:', error);
            }
        };

        // Delete session from cloud
        window.deleteSessionFromCloud = async function(sessionId) {
            if (!userId || !isOnline) return;

            try {
                await deleteDoc(doc(db, `users/${userId}/sessions`, sessionId.toString()));
            } catch (error) {
                console.error('Error deleting session:', error);
            }
        };

        // Auto-save timer state every 5 seconds for active sessions
        let autoSaveCount = 0;
        setInterval(() => {
            if (window.sessionActive && userId && isOnline) {
                syncTimerStateToCloud();
                autoSaveCount++;

                // Log state snapshot every 12th auto-save (once per minute)
                if (autoSaveCount % 12 === 0) {
                    console.log('üì∏ Auto-save state snapshot (1 minute)');
                    if (window.logTimerStateSnapshot) {
                        window.logTimerStateSnapshot();
                    }
                }
            }
        }, 5000);
        
        // Also sync when page is about to unload
        window.addEventListener('beforeunload', () => {
            if (window.sessionActive && window.syncTimerStateToCloud) {
                // Use sendBeacon for reliable sync on page unload
                syncTimerStateToCloud();
            }
        });

        // Initialize Firebase authentication
        authenticateUser();

        // Expose functions to window for use in main script
        window.firebaseReady = true;
        window.syncToCloud = syncAllData;
    </script>
</body>
</html>
